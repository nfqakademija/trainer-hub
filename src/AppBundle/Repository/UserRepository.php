<?php

namespace AppBundle\Repository;

use Doctrine\ORM\EntityRepository;
use AppBundle\Entity\Training;

/**
 * UserRepository
 *
 * This class was generated by the Doctrine ORM. Add your own custom
 * repository methods below.
 */
class UserRepository extends EntityRepository
{
    public function findByRoles($role)
    {

        return $this->createQueryBuilder('u')->where('u.roles LIKE :role')
            ->setParameter(':role', '%"'.$role.'"%')->getQuery();
    }

    public function findWithTrainings($user)
    {
        $username = $user['username'];

        return $this->createQueryBuilder('u')
            ->leftJoin('u.training', 't')
            ->addSelect('t')
            ->leftJoin('t.category', 'ca')
            ->addSelect('ca')
            ->leftJoin('t.city', 'ci')
            ->addSelect('ci')
            ->where('u.usernameCanonical = :username')
            ->setParameter(':username', $username)->getQuery()->getSingleResult();
    }

    public function findCities()
    {
        return $this->createQueryBuilder('u')->select('u.city')->getQuery()->getArrayResult();

    }

    public function filterByCity($city) {
        return $this->createQueryBuilder('u')
            ->where('u.city = :city AND u.roles LIKE :role')
            ->setParameters(array('city' => $city, 'role' => '%ROLE_TRAINER%'))->getQuery()->getArrayResult();
    }
}
